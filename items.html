<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Compartilha√≠ ‚Äî Itens</title>

  <style>
    :root{
      --bg:#070a14;
      --panel:#0c1226;
      --panel2:#0b1020;
      --line: rgba(255,255,255,.12);
      --txt:#ffffff;
      --muted: rgba(255,255,255,.72);
      --muted2: rgba(255,255,255,.55);
      --brand:#4f7cff;
      --ok:#23c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }

    body{
      margin:0;
      font-family: Arial, sans-serif;
      color:var(--txt);
      background:
        radial-gradient(1200px 600px at 15% 0%, rgba(79,124,255,.25), transparent 60%),
        radial-gradient(900px 500px at 90% 20%, rgba(0,255,199,.12), transparent 55%),
        var(--bg);
    }

    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 18px 14px 120px;
    }

    /* Topbar */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:14px 14px;
      background: linear-gradient(180deg, rgba(12,18,38,.92), rgba(11,16,32,.92));
      border: 1px solid var(--line);
      border-radius: 18px;
      box-shadow: var(--shadow);
      position: sticky;
      top: 10px;
      z-index: 50;
      backdrop-filter: blur(10px);
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 160px;
    }
    .logo{
      width:34px;height:34px;
      border-radius: 10px;
      background: radial-gradient(circle at 30% 30%, rgba(79,124,255,.9), rgba(79,124,255,.15));
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 10px 30px rgba(79,124,255,.25);
    }
    .brand h1{
      font-size: 14px;
      margin:0;
      line-height:1.1;
      letter-spacing:-.2px;
    }
    .brand small{
      display:block;
      color: var(--muted2);
      font-size: 12px;
      margin-top: 2px;
    }

    .actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--txt);
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 800;
      font-size: 13px;
      cursor:pointer;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      transition: transform .12s ease, background .12s ease, box-shadow .12s ease;
      user-select:none;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.09); }
    .btn-primary{
      background: linear-gradient(180deg, var(--brand), #3f68ff);
      border-color: rgba(255,255,255,.12);
      box-shadow: 0 14px 40px rgba(79,124,255,.25);
    }
    .btn-primary:hover{ box-shadow: 0 18px 44px rgba(79,124,255,.35); }
    .btn-danger{
      background: rgba(239,68,68,.14);
      border-color: rgba(239,68,68,.35);
    }

    /* Headline area */
    .headline{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:14px;
      margin: 18px 2px 12px;
    }
    .headline h2{
      margin:0;
      font-size: 18px;
      letter-spacing: -.3px;
    }
    .headline p{
      margin:6px 0 0;
      color: var(--muted);
      font-size: 13px;
      max-width: 640px;
    }

    /* Filters */
    .filters{
      display:flex;
      flex-wrap: wrap;
      gap:10px;
      margin: 14px 0 14px;
    }
    .chip{
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      padding: 10px 12px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 13px;
      cursor:pointer;
      transition: background .12s ease, transform .12s ease, border-color .12s ease;
      user-select:none;
    }
    .chip:hover{ transform: translateY(-1px); background: rgba(255,255,255,.08); }
    .chip.active{
      color: #fff;
      border-color: rgba(79,124,255,.55);
      background: rgba(79,124,255,.18);
      box-shadow: 0 14px 30px rgba(79,124,255,.14);
    }

    /* Grid list */
    .grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 14px;
      margin-top: 12px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 640px){
      .grid{ grid-template-columns: 1fr; }
      .brand{ min-width: unset; }
    }

    .card{
      background: linear-gradient(180deg, rgba(12,18,38,.92), rgba(11,16,32,.92));
      border: 1px solid var(--line);
      border-radius: 18px;
      padding: 14px;
      box-shadow: var(--shadow);
      display:flex;
      flex-direction: column;
      gap: 10px;
      overflow:hidden;
      position:relative;
    }
    .card .tag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 900;
    }
    .card h3{
      margin:0;
      font-size: 16px;
      letter-spacing: -.25px;
      line-height: 1.25;
    }
    .card .notes{
      margin:0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
      min-height: 34px;
    }
    .card .row{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      margin-top: 4px;
    }
    .price{
      font-size: 15px;
      font-weight: 900;
      color: var(--brand);
      white-space:nowrap;
    }

    .card .ghost-btn{
      width: 100%;
      justify-content: center;
      padding: 12px;
      border-radius: 14px;
      font-size: 13px;
    }

    /* States */
    .state{
      margin-top: 14px;
      background: rgba(255,255,255,.05);
      border: 1px solid var(--line);
      border-radius: 18px;
      padding: 14px;
      color: var(--muted);
      box-shadow: var(--shadow);
    }
    .state strong{ color:#fff; }

    .spinner{
      width: 14px;
      height: 14px;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,.25);
      border-top-color: rgba(255,255,255,.9);
      display:inline-block;
      animation: spin 0.9s linear infinite;
      vertical-align: middle;
      margin-right: 8px;
    }
    @keyframes spin{ to{ transform: rotate(360deg);} }

    /* Floating add button */
    .fab{
      position: fixed;
      right: 16px;
      bottom: 16px;
      z-index: 99;
      background: linear-gradient(180deg, var(--brand), #3f68ff);
      color: #fff;
      border: 0;
      border-radius: 999px;
      padding: 14px 16px;
      font-weight: 900;
      box-shadow: 0 18px 60px rgba(79,124,255,.35);
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .fab:active{ transform: translateY(1px); }
    .fab small{ font-weight: 900; opacity:.95; }

    footer{
      position: fixed;
      bottom: 10px;
      width: 100%;
      text-align: center;
      color: var(--muted2);
      font-size: 12px;
      opacity: .75;
      pointer-events:none;
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Compartilha√≠</h1>
          <small id="userLine">Carregando usu√°rio‚Ä¶</small>
        </div>
      </div>

      <div class="actions">
        <a class="btn" href="index.html">üè† In√≠cio</a>
        <a class="btn btn-primary" href="add-item.html">‚ûï Adicionar item</a>
        <button class="btn btn-danger" id="logoutBtn">Sair</button>
      </div>
    </div>

    <div class="headline">
      <div>
        <h2>Itens dispon√≠veis</h2>
        <p>
          Selecione uma categoria para filtrar. No MVP, o bot√£o ‚ÄúReservar‚Äù pode ficar como demonstra√ß√£o visual.
        </p>
      </div>
    </div>

    <div class="filters" id="filters">
      <div class="chip active" data-cat="Todos">Todos</div>
      <div class="chip" data-cat="Ferramentas">Ferramentas</div>
      <div class="chip" data-cat="Cozinha">Cozinha</div>
      <div class="chip" data-cat="Viagem">Viagem</div>
      <div class="chip" data-cat="Eletr√¥nicos">Eletr√¥nicos</div>
      <div class="chip" data-cat="Outros">Outros</div>
    </div>

    <div id="stateBox" class="state">
      <span class="spinner"></span>
      <strong>Carregando itens‚Ä¶</strong> Aguarde alguns segundos.
    </div>

    <div id="grid" class="grid" style="display:none;"></div>

  </div>

  <button class="fab" onclick="location.href='add-item.html'">
    ‚ûï <small>Novo item</small>
  </button>

  <footer>MVP ‚Äî Compartilha√≠ ¬©</footer>

  <!-- IMPORTANTE:
       Mantive seu padr√£o de projeto: arquivo do Firebase e script principal.
       Se seus nomes forem diferentes, me fala que eu ajusto.
  -->
  <script src="firebases.js"></script>
  <script src="script.js"></script>

  <script>
    // =========================
    // FALLBACK: waitFirebaseReady (pra evitar o erro "window.waitFirebaseReady is not a function")
    // =========================
    if (typeof window.waitFirebaseReady !== "function") {
      window.waitFirebaseReady = function(timeoutMs = 8000) {
        return new Promise((resolve, reject) => {
          const start = Date.now();
          const tick = () => {
            // alguns projetos setam window.__FIREBASE_READY__ = true
            const readyFlag = (window.__FIREBASE_READY__ === true);
            const hasAuthApi = (typeof window.AuthAPI !== "undefined");
            const hasItemsApi = (typeof window.ItemsAPI !== "undefined");

            if (readyFlag || (hasAuthApi && hasItemsApi)) return resolve(true);
            if (Date.now() - start > timeoutMs) return reject(new Error("Firebase n√£o ficou pronto a tempo."));
            setTimeout(tick, 120);
          };
          tick();
        });
      };
    }

    // =========================
    // UI helpers
    // =========================
    const stateBox = document.getElementById("stateBox");
    const grid = document.getElementById("grid");
    const filters = document.getElementById("filters");
    const logoutBtn = document.getElementById("logoutBtn");
    const userLine = document.getElementById("userLine");

    let currentCat = "Todos";
    let allItems = [];

    function setState(html, showSpinner=true){
      stateBox.style.display = "block";
      grid.style.display = "none";
      stateBox.innerHTML = (showSpinner ? '<span class="spinner"></span>' : '') + html;
    }

    function showGrid(){
      stateBox.style.display = "none";
      grid.style.display = "grid";
    }

    function emojiFor(cat){
      const map = {
        "Ferramentas":"üîß",
        "Cozinha":"üç≥",
        "Viagem":"üß≥",
        "Eletr√¥nicos":"‚ö°",
        "Outros":"üì¶"
      };
      return map[cat] || "üìå";
    }

    function money(v){
      const n = Number(v || 0);
      if (Number.isNaN(n)) return "R$ 0 / dia";
      return "R$ " + n.toFixed(0) + " / dia";
    }

    function render(){
      const list = (currentCat === "Todos")
        ? allItems
        : allItems.filter(x => (x.category || x.cat) === currentCat);

      if (!list.length){
        setState(`<strong>Nenhum item encontrado</strong><br><span style="color:rgba(255,255,255,.65)">Tente outra categoria ou adicione um novo item.</span>`, false);
        return;
      }

      grid.innerHTML = list.map(item => {
        const name = item.name || "Item";
        const category = item.category || item.cat || "Outros";
        const notes = item.notes || item.obs || "";
        const price = item.pricePerDay ?? item.price ?? item.valor ?? 0;

        return `
          <div class="card">
            <div class="tag">${emojiFor(category)} ${category}</div>
            <h3>${escapeHtml(name)}</h3>
            <p class="notes">${escapeHtml(notes || "Sem observa√ß√µes.")}</p>
            <div class="row">
              <div class="price">${money(price)}</div>
            </div>
            <button class="btn ghost-btn" onclick="alert('MVP: reserva ser√° implementada depois.')">Reservar</button>
          </div>
        `;
      }).join("");

      showGrid();
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // =========================
    // Hooks
    // =========================
    filters.querySelectorAll(".chip").forEach(btn => {
      btn.addEventListener("click", () => {
        filters.querySelectorAll(".chip").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        currentCat = btn.dataset.cat;
        render();
      });
    });

    logoutBtn.addEventListener("click", async () => {
      try{
        if (window.AuthAPI && typeof AuthAPI.logout === "function") {
          await AuthAPI.logout();
        }
      }catch(e){}
      location.href = "login.html";
    });

    // =========================
    // Load
    // =========================
    async function boot(){
      try{
        setState(`<strong>Carregando itens‚Ä¶</strong> Aguarde alguns segundos.`);
        await window.waitFirebaseReady(10000);

        // Protege rota (se seu AuthAPI existir)
        if (window.AuthAPI && typeof AuthAPI.onChange === "function") {
          AuthAPI.onChange((user) => {
            if (!user) {
              location.href = "login.html";
              return;
            }
            userLine.textContent = user.email ? `Logado: ${user.email}` : "Logado";
          });
        } else {
          userLine.textContent = "MVP";
        }

        // Busca itens (se seu ItemsAPI existir)
        if (!window.ItemsAPI || typeof ItemsAPI.list !== "function") {
          setState(`<strong>ItensAPI n√£o encontrada.</strong><br><span style="color:rgba(255,255,255,.65)">Confere se o arquivo <b>firebases.js</b> est√° exportando <b>ItemsAPI.list()</b>.</span>`, false);
          return;
        }

        allItems = await ItemsAPI.list();
        if (!Array.isArray(allItems)) allItems = [];
        render();

      } catch(err){
        console.error(err);
        setState(`<strong>N√£o consegui carregar os itens.</strong><br><span style="color:rgba(255,255,255,.65)">${escapeHtml(err.message || err)}</span>`, false);
      }
    }

    boot();
  </script>
</body>
</html>
